

# 如何构建前端代码检查工作流

### 引言

日常开发过程中，为了避免一些不必要代码甚至是错误代码（如：重复定义、undefined、已定义未使用等）提交到代码库中，可以使用husky、commitlint 和 lint-staged构建前端代码检查工作流。

- 提交代码时，在 commit 之前对代码进行 lint，并尝试自动修复错误，在修复不了的时候，抛出错误并终止 commit

- 在commit 时检查 git 提交规范，如果不符合规范同样会终止 commit

### 工具

- eslint ：代码检查工具
- husky：注册 git hook
- lint-staged：在提交的文件中，执行自定义的指令
- commitlint：搭配 `husky` 的 commit message 钩子，提交代码时根据配置的规则进行校验

### 安装

```bash
# husky
yarn add husky@1.3.1 -D

# lint-stage
yarn add lint-staged@8.1.5 -D  # Node版本要求：8.12.0 || >=9.7.0
```

### 配置

#### 配置 commitlint

`commitlint` 搭配 `husky` 的 commit message 钩子后，每次提交代码的时候，会根据配置的规则进行校验，若不符合规则 commit 会失败，并提示相应信息。

安装 commitlint 依赖

```bash
yarn add @commitlint/{cli,config-conventional} -D
```

新建 commitlint.config.js 文件

```js
module.exports = {
    extends: ['@commitlint/config-conventional']
};
```

**commitlint.config.js 配置文件可以添加自己的规则，这里 @commitlint/config-conventional 提供了官方的规则扩展：**

```json
build：主要目的是修改项目构建系统(例如 glup，webpack，rollup 的配置等)的提交
ci：主要目的是修改项目继续集成流程(例如 Travis，Jenkins，GitLab CI，Circle等)的提交
docs：文档更新
feat：新增功能
merge：分支合并 Merge branch ? of ?
fix：bug 修复
perf：性能, 体验优化
refactor：重构代码(既没有新增功能，也没有修复 bug)
style：不影响程序逻辑的代码修改(修改空白字符，格式缩进，补全缺失的分号等，没有改变代码逻辑)
test：新增测试用例或是更新现有测试
revert：回滚某个更早之前的提交
chore：不属于以上类型的其他类型
```

#### 配置 package.json 文件

```json
"husky": {
  "hooks": {
    "pre-commit": "lint-staged",
    "commit-msg": "commitlint -E HUSKY_GIT_PARAMS"
  }
},
"lint-staged": {
  "src/**/*.{js,vue}": [
    "eslint --fix",
    "git add"
  ]
},
```

`husky`会在你提交前，调用`pre-commit`钩子，执行`lint-staged`，如果代码不符合`prettier`配置的规则，会进行格式化；然后再用`eslint`的规则进行检查，如果有不符合规则且无法自动修复的，就会停止此次提交。如果都通过了就会讲代码添加到stage，然后`commit`。

#### 测试

```bash
git add .
git commit -m "foo: this will fail"
```

#### 跳过校验

使用 `--no-verify` 指令可以跳过检验规则

```
git add . && git commit --no-verify -m "代码规范强制提交测试"
```

#### eslint 常用配置

```js
# .eslintrc.js
module.exports = {
  parser: 'babel-eslint',
  plugins: ['react'],
  root: true,
  env: {
    browser: true,
    node: true,
    es6: true
  },
  parserOptions: {
    ecmaVersion: 6,
    sourceType: 'module'
  },
  globals: {
    document: true,
    localStorage: true,
    window: true,
    process: true,
    console: true,
    navigator: true,
    fetch: true,
    URL: true
  },
  rules: {
    'no-console': 'off',
    'no-alert': 0, //禁止使用alert confirm prompt
    'no-var': 0, //禁用var，用let和const代替
    'no-catch-shadow': 2, //禁止catch子句参数与外部作用域变量同名
    'default-case': 2, //switch语句最后必须有default
    'dot-notation': [0, { allowKeywords: true }], //避免不必要的方括号
    'no-constant-condition': 2, //禁止在条件中使用常量表达式 if(true) if(1)
    'no-dupe-args': 2, //函数参数不能重复
    'no-inline-comments': 0, //禁止行内备注
    'no-unreachable': 2, //不能有无法执行的代码
    'no-unused-vars': [2, { vars: 'all', args: 'after-used' }], //不能有声明后未被使用的变量或参数
    'no-unused-expressions': 2, //禁止无用的表达式 | 短路求值和三目运算都允许 0 | 2 都不允许
    // 'no-unused-expressions': [
    //   2,
    //   { allowShortCircuit: false, allowTernary: true },
    // ], // 允许三目，不允许短路：
    'no-mixed-spaces-and-tabs': [2, false], //禁止混用tab和空格
    'linebreak-style': [0, 'windows'], //换行风格
    'no-multiple-empty-lines': [1, { max: 2 }], //空行最多不能超过2行
    'no-extra-semi': 2, //禁止多余的冒号
    'no-debugger': 2, //禁止使用debugger
    // 'space-before-function-paren': [2, { anonymous: 'never', named: 'never' }], // 函数名后面加空格
    // 'space-before-function-paren': ['error', 'always'],
    // or
    'space-before-function-paren': [
      'error',
      {
        anonymous: 'always',
        named: 'always',
        asyncArrow: 'always'
      }
    ],
    'eol-last': 0, //文件以单一的换行符结束
    // eqeqeq: true, //必须使用全等 如果是true，则要求在所有的比较时使用===和!==
    // eqnull: true, // 如果是true，则允许使用== null
    'lines-around-comment': 0, //行前/行后备注
    'operator-linebreak': [2, 'after'], //换行时运算符在行尾还是行首
    'prefer-const': 0, //首选const
    quotes: [1, 'single'], //引号类型 `` "" ''
    'id-match': 0, //命名检测
    'array-bracket-spacing': [2, 'always'], // 指定数组的元素之间要以空格隔开(,后面)， never参数：[ 之前和 ] 之后不能带空格，always参数：[ 之前和 ] 之后必须带空格
    quotes: [2, 'single'], // 全部单引号
    // 数组和对象键值对最后一个逗号， never参数：不能带末尾的逗号, always参数：必须带末尾的逗号，
    // always-multiline：多行模式必须带逗号，单行模式不能带逗号
    'comma-dangle': [2, 'never'],
    'computed-property-spacing': [2, 'never'], // 以方括号取对象属性时，[ 后面和 ] 前面是否需要空格, 可选参数 never, always
    semi: [2, 'never'], //语句强制分号结尾  不要分号
    'eol-last': 2, // 文件末尾强制换行
    'semi-spacing': [0, { before: false, after: true }], //分号前后空格
    'arrow-body-style': 0, // 不禁止箭头函数直接return对象
    strict: 2, //使用严格模式
    'use-isnan': 2, //禁止比较时使用NaN，只能用isNaN()
    'valid-typeof': 2, //必须使用合法的typeof的值
    'space-in-parens': [0, 'always'],
    'template-curly-spacing': [2, 'always'],
    'array-bracket-spacing': [2, 'always'],
    'object-curly-spacing': [2, 'always'],
    'computed-property-spacing': [2, 'always'],
    'no-multiple-empty-lines': [2, { max: 1, maxEOF: 0, maxBOF: 0 }],
    quotes: [1, 'single', 'avoid-escape'],
    'no-use-before-define': [2, { functions: false }],
    semi: [0, 'never'],
    'prefer-const': 1,
    'react/prefer-es6-class': 0,
    'react/jsx-filename-extension': 0,
    'react/jsx-curly-spacing': [2, 'always'],
    'react/jsx-indent': [2, 2],
    'react/prop-types': [1],
    'react/no-array-index-key': [1],
    'class-methods-use-this': 'off',
    'no-undef': [1],
    'no-case-declarations': [1],
    'no-return-assign': [1],
    'no-param-reassign': [1],
    'no-shadow': [1],
    camelcase: [1],
    'no-unused-vars': 'off',
    'no-underscore-dangle': [0, 'always']
  }
}
```

### 可选：[styleLint](https://cloud.tencent.com/developer/section/1489630)检查vue项目样式

安装依赖：

```bash
yarn add stylelint stylelint-config-standard  -D

yarn add stylelint-config-rational-order stylelint-order -D

yarn add stylelint-scss stylelint-webpack-plugin -D
```

**stylelint**：检查工具

**stylelint-config-standard**：stylelint的推荐配置

**stylelint-order**：CSS属性排序插件，并且每个规则都支持自动修复（stylelint --fix）

**stylelint-config-rational-order**：stylelint-order配置，通过按照以下顺序将相关属性声明进行分组来对它们进行排序：

![mark](http://gongyz.oss-cn-shenzhen.aliyuncs.com/blog/20200203/104941167.png)

**stylelint-scss**：stylelint本身就很好地支持SCSS语法（以及其他预处理器的语法），但是stylelint通常专注于标准CSS。而引入了特定于SCSS语法的规则。

**stylelint-webpack-plugin**：是webpack插件，使用 stylelint 检查CSS/SCSS代码

项目配置：

```json
# webpack.dev.conf.js
var StyleLintPlugin = require('stylelint-webpack-plugin')

new StyleLintPlugin({
  files: ['src/**/*.{vue, scss}'],
  failOnError: false,
  fix: true
  // cache: true
})

# 项目根目录下添加 .stylelintrc.json
{
  "extends": "stylelint-config-standard",
  "rules": {
    "at-rule-no-unknown": [ true, {
      "ignoreAtRules": [
        "extends",
        "ignores"
      ]
    }],
    "no-empty-source": null,
    "rule-empty-line-before": null,
    "at-rule-empty-line-before": null
  }
}
```

